name: Directory as shared area
on: push
jobs:
  test-dir:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create dir
        run: |
          mkdir mydata

# I have not found out how to pass the volume with steps with "uses:" 
# "volumes: mydata:/code" has no effect (and is invalid)
# Going back to brute force "docker run"...
      - name: Get the full metadata 
        run: |
          pwd
          ls -l
          docker run --rm cernopendata/cernopendata-client:0.3.0 get-metadata --recid 24103 > mydata/metadata.json
          docker run --rm cernopendata/cernopendata-client:0.3.0 get-file-locations --recid 24103 --protocol xrootd> mydata/file-locations.json

# Github runners have python so OK for now. This could be done in a python container.
      - name: Read parameters from metadata
        run: |
          python read_metadata.py > mydata/var.sh

# This optional, only if type=Collision, or if VALI_RECID exists
# Could be done with github variable but keep it bash for now...
      - name: Download a the validated runs file
        run: |
          pwd
          cat mydata/var.sh
          source mydata/var.sh
          echo $VALI_RECID
          [ ! -z $VALI_RECID ] && docker run --rm -v $PWD/mydata:/code -u root cernopendata/cernopendata-client:0.3.0 download-files --recid $VALI_RECID --protocol xrootd

      - name: List data
        run: | 
          pwd
          ls -l mydata
          cat mydata/var.sh
